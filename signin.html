<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8" />

        <title>GBA Online - Sign In</title>

        <link rel="stylesheet" href="./stylesheets/signin.css" />
    </head>

    <body>
        <!-- partial:index.partial.html -->

        <section>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>
            <span></span> <span></span> <span></span> <span></span>

            <div class="signin">
                <div class="content">
                    <div class="d-flex">
                        <figure class="reverted-horizontal d-inline">
                            <img
                                src="./assets/gif/characters/knuckles.gif"
                                alt=""
                                width="400"
                                height="200"
                            />
                        </figure>
                        <figure class="d-inline">
                            <img
                                src="./assets/gif/gameboy/flying-gameboy.gif"
                                alt=""
                                width="400"
                                height="200"
                            />
                        </figure>
                        <figure class="d-inline">
                            <img
                                src="./assets/gif/characters/knuckles.gif"
                                alt=""
                                width="400"
                                height="200"
                            />
                        </figure>
                    </div>
                    <h2>Sign In</h2>

                    <div class="form">
                        <div class="inputBox">
                            <input id="control_username" type="text" required /> <i>Username</i>
                        </div>

                        <div class="inputBox">
                            <input id="control_password" type="password" required /> <i>Password</i>
                        </div>

                        <div class="links">
                            <a href="/forgot-password.html">Forgot Password</a>
                            <a href="/signup.html">Sign Up</a>
                        </div>

                        <div class="inputBox">
                            <input id='btnSend' type="submit" value="Login" />
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- partial -->
        <script type="module">
            import { getUserByUsername, localStorageKeys } from '/modules/user/account.js';
            import { getEncryptedPassword } from "/modules/general/encryption.js";

            const PAGE_CONTROLS = {
                'Username': document.getElementById('control_username'),
                'Password': document.getElementById('control_password'),
                'SubmitButton': document.getElementById('btnSend'),
            };

            const MESSAGES = {
                'WrongPassword': "Wrong password",
            };

            const proceedToLogIn = async () => {
                const user = await getUserByUsername(PAGE_CONTROLS.Username.value);
                const password = await getEncryptedPassword({ 
                    'encryptedEncryptionKey': user.encryption_key, 
                    'password': document.getElementById('control_password').value });

                if(password == user.password) {
                    window.location.href = "/index.html";
                    localStorage.setItem(
                        localStorageKeys.CURRENT_USERNAME,
                        user.id
                    );
                }else{
                    alert(MESSAGES.WrongPassword);
                    localStorage.removeItem(
                        localStorageKeys.CURRENT_USERNAME
                    );
                }
            };

            PAGE_CONTROLS.SubmitButton.addEventListener('click', () => {
                proceedToLogIn();
            });
        </script>
    </body>
</html>
